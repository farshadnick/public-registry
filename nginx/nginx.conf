events {
    worker_connections 1024;
}

http {
    upstream nexus {
        server nexus:8081;
    }

    upstream landing {
        server landing:3000;
    }

    upstream docker_registry {
        server nexus:8082;
    }

    # Docker Registry - docker.adlas.cloud
    server {
        listen 80;
        server_name docker.adlas.cloud;
        client_max_body_size 0;  # Disable size limit for Docker images
        chunked_transfer_encoding on;

        location / {
            proxy_pass http://docker_registry;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # Required for Docker Registry
            proxy_read_timeout 900;
            proxy_buffering off;
        }
    }

    # Main server - Landing page and Nexus UI
    server {
        listen 80 default_server;
        server_name _;
        client_max_body_size 1G;

        # Landing page
        location / {
            proxy_pass http://landing;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Nexus UI
        location /nexus/ {
            proxy_pass http://nexus/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Docker registry (fallback)
        location /v2/ {
            proxy_pass http://docker_registry/v2/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

